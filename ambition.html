<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ambition - Gamified Productivity</title>
  <script src="./lib/react.production.min.js"></script>
  <script src="./lib/react-dom.production.min.js"></script>
  <script src="./lib/babel.min.js"></script>
  <link href="./output.css" rel="stylesheet" onload="console.log('CSS loaded successfully')" onerror="console.error('Failed to load output.css')">
</head>
<body className="min-h-screen bg-gray-900 text-white" style="background-color: #111827; min-height: 100vh;">
  <div id="root" className="min-h-screen p-4 max-w-4xl mx-auto px-4 sm:px-4"></div>

  <script type="text/babel">
    console.log('Script loading check:', typeof React, typeof ReactDOM, typeof Babel);
    console.log('Layout classes applied: max-w-4xl mx-auto px-4 sm:px-4');
    const { useState, useEffect } = React;

    function getDateString(date = new Date()) {
      return date.toDateString();
    }

    function AmbitionApp() {
      const [goals, setGoals] = useState(() => {
        const saved = localStorage.getItem('ambitionGoals');
        if (!saved) return [];
        try {
          const parsed = JSON.parse(saved);
          const convertedGoals = Array.isArray(parsed)
            ? parsed.map((item, index) => {
                if (typeof item === 'string') {
                  return { id: String(Date.now() + index), text: item };
                } else if (typeof item === 'object' && item && item.text) {
                  return { id: String(item.id || Date.now() + index), text: String(item.text) };
                } else {
                  return { id: String(Date.now() + index), text: 'Unnamed Goal' };
                }
              })
            : [];
          console.log('Loaded goals:', convertedGoals);
          return convertedGoals;
        } catch (e) {
          console.error('Failed to parse ambitionGoals:', e);
          return [];
        }
      });
      const [tasks, setTasks] = useState(() => {
        const saved = localStorage.getItem('ambitionTasks');
        if (!saved) return [];
        try {
          const parsed = JSON.parse(saved);
          const convertedTasks = Array.isArray(parsed)
            ? parsed.map(task => ({
                ...task,
                id: task.id || Date.now(),
                notes: task.notes || '',
                goalId: String(task.goalId || task.goal || '')
              }))
            : [];
          console.log('Loaded tasks:', convertedTasks);
          return convertedTasks;
        } catch (e) {
          console.error('Failed to parse ambitionTasks:', e);
          return [];
        }
      });
      const [newTask, setNewTask] = useState('');
      const [newGoal, setNewGoal] = useState('');
      const [category, setCategory] = useState('Relevant');
      const [urgent, setUrgent] = useState(false);
      const [important, setImportant] = useState(false);
      const [newTaskNotes, setNewTaskNotes] = useState('');
      const [newTaskGoalId, setNewTaskGoalId] = useState('');
      const [filterGoalId, setFilterGoalId] = useState('');
      const [lifetimePoints, setLifetimePoints] = useState(() => {
        const saved = localStorage.getItem('ambitionLifetimePoints');
        return saved ? parseInt(saved, 10) || 0 : 0;
      });
      const [decayDays, setDecayDays] = useState(() => {
        const saved = localStorage.getItem('ambitionDecayDays');
        return saved ? parseInt(saved, 10) || 7 : 7;
      });
      const [dailyHistory, setDailyHistory] = useState(() => {
        const saved = localStorage.getItem('ambitionDailyHistory');
        if (!saved) return {};
        try {
          return JSON.parse(saved) || {};
        } catch (e) {
          console.error('Failed to parse ambitionDailyHistory:', e);
          return {};
        }
      });
      const [lastProcessedDate, setLastProcessedDate] = useState(() => {
        const saved = localStorage.getItem('ambitionLastProcessedDate');
        return saved || getDateString(new Date(0));
      });
      const [streak, setStreak] = useState(() => {
        const saved = localStorage.getItem('ambitionStreak');
        return saved ? parseInt(saved, 10) || 0 : 0;
      });
      const [streakDates, setStreakDates] = useState(() => {
        const saved = localStorage.getItem('ambitionStreakDates');
        return saved ? JSON.parse(saved) || [] : [];
      });
      const [editingTaskId, setEditingTaskId] = useState(null);
      const [editTask, setEditTask] = useState({
        text: '',
        category: 'Relevant',
        urgent: false,
        important: false,
        notes: '',
        goalId: ''
      });
      const [editingGoalId, setEditingGoalId] = useState(null);
      const [editGoalText, setEditGoalText] = useState('');

      const today = getDateString();
      const [currentDayBase, setCurrentDayBase] = useState(0);

      const pointValues = {
        Relevant: 5,
        Other: 3,
        Chores: 2,
        People: 5,
        Backlog: 5,
        Abspielen: 1
      };

      useEffect(() => {
        localStorage.setItem('ambitionGoals', JSON.stringify(goals));
        localStorage.setItem('ambitionTasks', JSON.stringify(tasks));
        localStorage.setItem('ambitionLifetimePoints', lifetimePoints);
        localStorage.setItem('ambitionDecayDays', decayDays);
        localStorage.setItem('ambitionDailyHistory', JSON.stringify(dailyHistory));
        localStorage.setItem('ambitionLastProcessedDate', lastProcessedDate);
        localStorage.setItem('ambitionStreak', streak);
        localStorage.setItem('ambitionStreakDates', JSON.stringify(streakDates));
        console.log('Saved to localStorage - Goals:', goals, 'Tasks:', tasks, 'Decay Days:', decayDays, 'Streak:', streak, 'Streak Dates:', streakDates);
      }, [goals, tasks, lifetimePoints, decayDays, dailyHistory, lastProcessedDate, streak, streakDates]);

      useEffect(() => {
        const now = Date.now();
        const decayMs = decayDays * 86400000;
        setTasks(prevTasks =>
          prevTasks.map(task => {
            if (task.category !== 'Backlog' && (now - new Date(task.createdDate).getTime()) > decayMs) {
              return { ...task, category: 'Backlog', points: pointValues.Backlog };
            }
            return task;
          })
        );

        const todayDate = new Date(today);
        const lastProcessed = new Date(lastProcessedDate);
        if (todayDate > lastProcessed) {
          let newLifetime = lifetimePoints;
          let currentDate = new Date(lastProcessed);
          currentDate.setDate(currentDate.getDate() + 1);

          while (currentDate < todayDate) {
            const dateStr = getDateString(currentDate);
            const thisBase = dailyHistory[dateStr] || 0;
            const prevDateStr = getDateString(new Date(currentDate.getTime() - 86400000));
            const prevBase = dailyHistory[prevDateStr] || 0;
            if (thisBase > prevBase) {
              newLifetime += 5;
            }
            currentDate.setDate(currentDate.getDate() + 1);
          }
          setLifetimePoints(newLifetime);
          setLastProcessedDate(today);

          const yesterday = getDateString(new Date(todayDate.getTime() - 86400000));
          const hasActivityToday = dailyHistory[today] > 0 || streakDates.includes(today);
          const hasActivityYesterday = dailyHistory[yesterday] > 0 || streakDates.includes(yesterday);
          if (!hasActivityToday && !hasActivityYesterday) {
            setStreak(0);
            setStreakDates([]);
          }
        }

        setCurrentDayBase(dailyHistory[today] || 0);
      }, [dailyHistory, lastProcessedDate, streakDates]);

      const handleDecayDaysChange = (e) => {
        const value = parseInt(e.target.value, 10);
        if (!isNaN(value) && value >= 1) {
          setDecayDays(value);
        }
      };

      const addGoal = () => {
        if (newGoal.trim() === '') return;
        const newGoalObj = { id: String(Date.now()), text: newGoal.trim() };
        setGoals([...goals, newGoalObj]);
        console.log('Added goal:', newGoalObj);
        setNewGoal('');
      };

      const startEditingGoal = (goal) => {
        setEditingGoalId(goal.id);
        setEditGoalText(goal.text);
        console.log('Editing goal:', goal);
      };

      const updateGoal = (id) => {
        if (editGoalText.trim() === '') return;
        setGoals(goals.map(goal =>
          goal.id === id ? { ...goal, text: editGoalText.trim() } : goal
        ));
        console.log('Updated goal:', { id, text: editGoalText.trim() });
        setEditingGoalId(null);
        setEditGoalText('');
      };

      const cancelEditGoal = () => {
        setEditingGoalId(null);
        setEditGoalText('');
      };

      const deleteGoal = (id) => {
        setGoals(goals.filter(goal => goal.id !== id));
        setTasks(tasks.map(task =>
          task.goalId === id ? { ...task, goalId: '' } : task
        ));
        console.log('Deleted goal ID:', id, 'Tasks unlinked');
      };

      const completeGoal = (id) => {
        setGoals(goals.filter(goal => goal.id !== id));
        setTasks(tasks.map(task =>
          task.goalId === id ? { ...task, goalId: '' } : task
        ));
        console.log('Completed goal ID:', id, 'Tasks unlinked');
        const todayDate = getDateString();
        if (!streakDates.includes(todayDate)) {
          const newStreakDates = [...streakDates, todayDate];
          const sortedDates = newStreakDates.sort((a, b) => new Date(a) - new Date(b));
          let newStreak = 1;
          for (let i = 1; i < sortedDates.length; i++) {
            const prevDate = new Date(sortedDates[i - 1]);
            const currDate = new Date(sortedDates[i]);
            if ((currDate - prevDate) === 86400000) {
              newStreak++;
            } else if ((currDate - prevDate) > 86400000) {
              newStreak = 1;
            }
          }
          setStreak(newStreak);
          setStreakDates(newStreakDates);
        }
      };

      const addTask = () => {
        if (newTask.trim() === '') return;
        const taskPoints = pointValues[category] + (urgent ? 4 : 0) + (important ? 4 : 0);
        const newTaskObj = {
          id: Date.now(),
          text: newTask,
          category,
          points: taskPoints,
          urgent,
          important,
          createdDate: new Date().toISOString(),
          notes: newTaskNotes,
          goalId: newTaskGoalId || ''
        };
        setTasks([...tasks, newTaskObj]);
        console.log('Added task:', newTaskObj);
        setNewTask('');
        setNewTaskNotes('');
        setNewTaskGoalId('');
        setUrgent(false);
        setImportant(false);
      };

      const completeTask = (id) => {
        const task = tasks.find(t => t.id === id);
        if (!task) return;
        setTasks(tasks.filter(t => t.id !== id));
        setLifetimePoints(prev => prev + task.points);
        setDailyHistory(prev => ({
          ...prev,
          [today]: (prev[today] || 0) + task.points
        }));
        console.log('Completed task:', task);
        const todayDate = getDateString();
        if (!streakDates.includes(todayDate)) {
          const newStreakDates = [...streakDates, todayDate];
          const sortedDates = newStreakDates.sort((a, b) => new Date(a) - new Date(b));
          let newStreak = 1;
          for (let i = 1; i < sortedDates.length; i++) {
            const prevDate = new Date(sortedDates[i - 1]);
            const currDate = new Date(sortedDates[i]);
            if ((currDate - prevDate) === 86400000) {
              newStreak++;
            } else if ((currDate - prevDate) > 86400000) {
              newStreak = 1;
            }
          }
          setStreak(newStreak);
          setStreakDates(newStreakDates);
        }
      };

      const deleteTask = (id) => {
        setTasks(tasks.filter(t => t.id !== id));
        console.log('Deleted task ID:', id);
      };

      const startEditingTask = (task) => {
        setEditingTaskId(task.id);
        setEditTask({
          text: task.text,
          category: task.category,
          urgent: task.urgent,
          important: task.important,
          notes: task.notes || '',
          goalId: task.goalId || ''
        });
        console.log('Editing task:', task);
      };

      const updateTask = (id) => {
        const taskPoints = pointValues[editTask.category] + (urgent ? 4 : 0) + (important ? 4 : 0);
        const updatedTask = { ...editTask, points: taskPoints };
        setTasks(tasks.map(task =>
          task.id === id ? { ...task, ...updatedTask } : task
        ));
        console.log('Updated task:', updatedTask);
        setEditingTaskId(null);
      };

      const cancelEdit = () => {
        setEditingTaskId(null);
        setEditTask({ text: '', category: 'Relevant', urgent: false, important: false, notes: '', goalId: '' });
      };

      const filteredTasks = filterGoalId
        ? tasks.filter(task => task.goalId === filterGoalId)
        : tasks;

      return (
        <div className="max-w-4xl mx-auto bg-gray-900 text-white min-h-screen px-4 sm:px-4" style={{ maxWidth: '64rem', marginLeft: 'auto', marginRight: 'auto', paddingLeft: '1rem', paddingRight: '1rem' }}>
          <header className="bg-gray-800 p-4 rounded-lg mb-4 max-w-4xl mx-auto px-4 sm:px-4">
            <div className="flex justify-between items-center">
              <h1 className="text-3xl font-bold text-yellow-400">Ambition</h1>
              <a href="/rules" className="bg-yellow-500 text-gray-900 p-2 rounded hover:bg-yellow-600">Rules</a>
            </div>
            <div className="mt-2">
              <span className="text-lg text-gray-300">{today}</span>
            </div>
            <div className="mt-2 flex justify-between items-center">
              <span className="text-xl text-white">Lifetime Points: {lifetimePoints}</span>
              <span className="text-lg text-gray-300">Today: {currentDayBase} pts</span>
            </div>
            <div className="mt-2">
              <div className="w-full bg-gray-700 rounded-full h-4">
                <div
                  className="bg-yellow-400 h-4 rounded-full"
                  style={{ width: `${Math.min((lifetimePoints % 1000) / 10, 100)}%` }}
                ></div>
              </div>
            </div>
            <div className="mt-2">
              <span className="text-lg text-gray-300">Streak: {streak} days</span>
              {streak >= 3 && (
                <span className="ml-4 inline-flex items-center px-3 py-1 rounded-full bg-green-500 text-white text-sm font-medium">
                  3-Day Streak Badge 🎉
                </span>
              )}
            </div>
          </header>
          <div className="bg-gray-800 p-4 rounded-lg mb-4 max-w-4xl mx-auto px-4 sm:px-4">
            <h2 className="text-xl font-semibold mb-2 text-white">Settings</h2>
            <div className="flex space-x-2 mb-2">
              <label className="text-white">Backlog Decay (days):</label>
              <input
                type="number"
                value={decayDays}
                onChange={handleDecayDaysChange}
                className="w-20 p-2 bg-gray-600 rounded text-white"
                min="1"
                placeholder="7"
              />
            </div>
          </div>
          <div className="bg-gray-800 p-4 rounded-lg mb-4 max-w-4xl mx-auto px-4 sm:px-4">
            <h2 className="text-xl font-semibold mb-2 text-white">Main Goals</h2>
            <div className="flex space-x-2 mb-2">
              <input
                type="text"
                value={newGoal}
                onChange={(e) => setNewGoal(e.target.value)}
                className="flex-1 p-2 bg-gray-600 rounded text-white"
                placeholder="Add a goal..."
              />
              <button
                onClick={addGoal}
                className="p-2 bg-yellow-500 text-gray-900 rounded hover:bg-yellow-600"
              >
                Add Goal
              </button>
            </div>
            <ul className="list-disc pl-6 space-y-2">
              {goals.map(goal => (
                <li key={goal.id} className="text-gray-300 flex items-center">
                  {editingGoalId === goal.id ? (
                    <div className="flex space-x-2 items-center w-full">
                      <input
                        type="text"
                        value={editGoalText}
                        onChange={(e) => setEditGoalText(e.target.value)}
                        className="flex-1 p-2 bg-gray-600 rounded text-white"
                        placeholder="Edit goal..."
                      />
                      <button
                        onClick={() => updateGoal(goal.id)}
                        className="p-2 bg-yellow-500 text-gray-900 rounded hover:bg-yellow-600"
                      >
                        Save
                      </button>
                      <button
                        onClick={cancelEditGoal}
                        className="p-2 bg-yellow-500 text-gray-900 rounded hover:bg-yellow-600"
                      >
                        Cancel
                      </button>
                    </div>
                  ) : (
                    <>
                      <span className="flex-1">{goal.text}</span>
                      <button
                        onClick={() => startEditingGoal(goal)}
                        className="p-2 bg-yellow-500 text-gray-900 rounded hover:bg-yellow-600 mr-2"
                      >
                        Edit
                      </button>
                      <button
                        onClick={() => completeGoal(goal.id)}
                        className="p-2 bg-green-500 text-white rounded hover:bg-green-600 mr-2"
                      >
                        Complete
                      </button>
                      <button
                        onClick={() => deleteGoal(goal.id)}
                        className="p-2 bg-red-500 text-white rounded hover:bg-red-600"
                      >
                        Delete
                      </button>
                    </>
                  )}
                </li>
              ))}
            </ul>
          </div>
          <div className="bg-gray-800 p-4 rounded-lg mb-4 max-w-4xl mx-auto px-4 sm:px-4">
            <h2 className="text-xl font-semibold mb-2 text-white">Add Task</h2>
            <div className="space-y-2">
              <input
                type="text"
                value={newTask}
                onChange={(e) => setNewTask(e.target.value)}
                className="w-full p-2 bg-gray-600 rounded text-white"
                placeholder="Task description..."
              />
              <textarea
                value={newTaskNotes}
                onChange={(e) => setNewTaskNotes(e.target.value)}
                className="w-full p-2 bg-gray-600 rounded text-white"
                placeholder="Task notes..."
                rows="3"
              ></textarea>
              <div className="flex space-x-2 mb-2">
                <select
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className="p-2 bg-gray-600 rounded flex-1 text-white"
                >
                  {Object.keys(pointValues).map(cat => (
                    <option key={cat} value={cat} className="text-white">{cat} ({pointValues[cat]} pts)</option>
                  ))}
                </select>
                <select
                  value={newTaskGoalId}
                  onChange={(e) => setNewTaskGoalId(e.target.value)}
                  className="p-2 bg-gray-600 rounded flex-1 text-white"
                >
                  <option value="" className="text-white">Unlinked</option>
                  {goals.map(goal => (
                    <option key={goal.id} value={goal.id} className="text-white">{goal.text}</option>
                  ))}
                </select>
              </div>
              <div className="flex space-x-4 mb-2">
                <label className="flex items-center text-white">
                  <input
                    type="checkbox"
                    checked={urgent}
                    onChange={(e) => setUrgent(e.target.checked)}
                    className="mr-1"
                  />
                  Urgent (+4 bonus)
                </label>
                <label className="flex items-center text-white">
                  <input
                    type="checkbox"
                    checked={important}
                    onChange={(e) => setImportant(e.target.checked)}
                    className="mr-1"
                  />
                  Important (+4 bonus)
                </label>
              </div>
              <button
                onClick={addTask}
                className="w-full p-2 bg-yellow-500 text-gray-900 rounded hover:bg-yellow-600"
              >
                Add Task
              </button>
            </div>
          </div>
          <div className="bg-gray-800 p-4 rounded-lg mb-4 max-w-4xl mx-auto px-4 sm:px-4">
            <h2 className="text-xl font-semibold mb-2 text-white">Tasks</h2>
            <div className="mb-4">
              <label className="text-sm text-gray-300 mr-2">Filter by Goal:</label>
              <select
                value={filterGoalId}
                onChange={(e) => setFilterGoalId(e.target.value)}
                className="p-2 bg-gray-600 rounded text-white"
              >
                <option value="" className="text-white">All Tasks</option>
                {goals.map(goal => (
                  <option key={goal.id} value={goal.id} className="text-white">{goal.text}</option>
                ))}
              </select>
            </div>
            <ul className="space-y-2">
              {filteredTasks.map(task => (
                <li key={task.id} className="p-3 bg-gray-700 rounded">
                  {editingTaskId === task.id ? (
                    <div className="space-y-2">
                      <input
                        type="text"
                        value={editTask.text}
                        onChange={(e) => setEditTask({ ...editTask, text: e.target.value })}
                        className="w-full p-2 bg-gray-600 rounded text-white"
                        placeholder="Task description..."
                      />
                      <textarea
                        value={editTask.notes}
                        onChange={(e) => setEditTask({ ...editTask, notes: e.target.value })}
                        className="w-full p-2 bg-gray-600 rounded text-white"
                        placeholder="Task notes..."
                        rows="3"
                      ></textarea>
                      <div className="flex space-x-2 mb-2">
                        <select
                          value={editTask.category}
                          onChange={(e) => setEditTask({ ...editTask, category: e.target.value })}
                          className="p-2 bg-gray-600 rounded flex-1 text-white"
                        >
                          {Object.keys(pointValues).map(cat => (
                            <option key={cat} value={cat} className="text-white">{cat} ({pointValues[cat]} pts)</option>
                          ))}
                        </select>
                        <select
                          value={editTask.goalId}
                          onChange={(e) => setEditTask({ ...editTask, goalId: e.target.value })}
                          className="p-2 bg-gray-600 rounded flex-1 text-white"
                        >
                          <option value="" className="text-white">Unlinked</option>
                          {goals.map(goal => (
                            <option key={goal.id} value={goal.id} className="text-white">{goal.text}</option>
                          ))}
                        </select>
                      </div>
                      <div className="flex space-x-4 mb-2">
                        <label className="flex items-center text-white">
                          <input
                            type="checkbox"
                            checked={editTask.urgent}
                            onChange={(e) => setEditTask({ ...editTask, urgent: e.target.checked })}
                            className="mr-1"
                          />
                          Urgent (+4 bonus)
                        </label>
                        <label className="flex items-center text-white">
                          <input
                            type="checkbox"
                            checked={editTask.important}
                            onChange={(e) => setEditTask({ ...editTask, important: e.target.checked })}
                            className="mr-1"
                          />
                          Important (+4 bonus)
                        </label>
                      </div>
                      <div className="flex space-x-2">
                        <button
                          onClick={() => updateTask(task.id)}
                          className="flex-1 p-2 bg-yellow-500 text-gray-900 rounded hover:bg-yellow-600"
                        >
                          Save
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="flex-1 p-2 bg-yellow-500 text-gray-900 rounded hover:bg-yellow-600"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <div className="flex justify-between items-center">
                      <div className="flex-1">
                        <div className="font-medium text-white">{task.text}</div>
                        <div className="text-sm text-gray-400">
                          {task.category} ({task.points} pts) | Created: {new Date(task.createdDate).toLocaleDateString()}
                          {task.urgent && <span className="ml-2 text-red-400">Urgent</span>}
                          {task.important && <span className="ml-2 text-blue-400">Important</span>}
                        </div>
                        {task.goalId && (
                          <div className="text-sm text-gray-300 mt-1">
                            Goal: {goals.find(goal => String(goal.id) === String(task.goalId))?.text || 'Unknown Goal'}
                          </div>
                        )}
                        {task.notes && (
                          <div className="text-sm text-gray-300 mt-1">Notes: {task.notes}</div>
                        )}
                      </div>
                      <div className="flex space-x-2">
                        <button
                          onClick={() => startEditingTask(task)}
                          className="p-2 bg-yellow-500 text-gray-900 rounded hover:bg-yellow-600"
                        >
                          Edit
                        </button>
                        <button
                          onClick={() => completeTask(task.id)}
                          className="p-2 bg-green-500 text-white rounded hover:bg-green-600"
                        >
                          Complete
                        </button>
                        <button
                          onClick={() => deleteTask(task.id)}
                          className="p-2 bg-red-500 text-white rounded hover:bg-red-600"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  )}
                </li>
              ))}
            </ul>
          </div>
          <div className="bg-gray-800 p-4 rounded-lg max-w-4xl mx-auto px-4 sm:px-4">
            <h3 className="text-lg font-semibold mb-2 text-white">Recent Daily Scores</h3>
            <ul className="space-y-1">
              {Object.entries(dailyHistory)
                .sort(([a], [b]) => new Date(b) - new Date(a))
                .slice(0, 7)
                .map(([date, pts]) => (
                  <li key={date} className="text-sm text-gray-300">{date}: {pts} pts</li>
                ))}
            </ul>
          </div>
          <footer className="bg-gray-800 p-4 text-center max-w-4xl mx-auto px-4 sm:px-4" style={{ backgroundColor: '#1f2937', padding: '1rem', textAlign: 'center' }}>
            <p>© 2025 Ambition. MIT License.</p>
          </footer>
        </div>
      );
    }

    ReactDOM.render(<AmbitionApp />, document.getElementById('root'));
  </script>
</body>
</html>
